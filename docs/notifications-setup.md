# Notifications System Setup

This document describes how to set up the notifications system in your Supabase database.

## Database Setup

### 1. Create the notifications table

Run the following SQL in your Supabase SQL editor:

```sql
CREATE TABLE IF NOT EXISTS public.notifications (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  account_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  body TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('info', 'warning', 'error')),
  dismissed BOOLEAN DEFAULT false,
  link TEXT,
  metadata JSONB
);

-- Index for faster queries
CREATE INDEX IF NOT EXISTS idx_notifications_account_id ON public.notifications(account_id);
CREATE INDEX IF NOT EXISTS idx_notifications_dismissed ON public.notifications(dismissed);
CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON public.notifications(created_at);

-- Set up RLS (Row Level Security)
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

-- Create policy for users to read only their own notifications
CREATE POLICY "Users can view their own notifications" 
  ON public.notifications FOR SELECT 
  USING (auth.uid() = account_id);

-- Create policy for users to update only their own notifications
CREATE POLICY "Users can update their own notifications" 
  ON public.notifications FOR UPDATE 
  USING (auth.uid() = account_id);

-- Allow service role to insert notifications
CREATE POLICY "Service role can insert notifications" 
  ON public.notifications FOR INSERT 
  TO service_role 
  WITH CHECK (true);
```

### 2. Create Function to Send Notifications

Create a Supabase function to send notifications to users:

```sql
CREATE OR REPLACE FUNCTION public.send_notification(
  p_account_id UUID,
  p_body TEXT,
  p_type TEXT DEFAULT 'info',
  p_link TEXT DEFAULT NULL,
  p_metadata JSONB DEFAULT NULL
) RETURNS VOID AS $$
BEGIN
  INSERT INTO public.notifications (
    account_id,
    body,
    type,
    link,
    metadata
  ) VALUES (
    p_account_id,
    p_body,
    p_type,
    p_link,
    p_metadata
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## Testing Your Notifications

You can test sending a notification using the SQL editor:

```sql
-- Example: Send a test notification
SELECT public.send_notification(
  'USER_ID_HERE', -- Replace with actual user ID
  'This is a test notification',
  'info',
  '/some-path',
  '{"additional": "metadata"}'::jsonb
);
```

## Client-Side Setup

The client-side notifications system is already set up in the app with the following components:

1. `lib/hooks.ts` - Contains the hooks for fetching and dismissing notifications
2. `context/notifications-provider.tsx` - Provides the notifications context to the app
3. `components/notification-card.tsx` - Renders individual notifications
4. `components/notification-badge.tsx` - Shows notification count in the tab bar

To use notifications in your app:

1. Make sure the `NotificationsProvider` is included in your app's root component
2. Use the `useNotifications` hook to access notification data and actions
3. Display notifications using the `NotificationCard` component

Example:

```tsx
import { useNotifications } from '@/context/notifications-provider';

function MyComponent() {
  const { notifications, dismissNotification } = useNotifications();
  
  // Use notifications in your component
}
```

## Real-time Notifications

Notifications use Supabase's real-time functionality to update immediately when new notifications are added. Make sure you have enabled real-time for the `notifications` table in your Supabase dashboard. 